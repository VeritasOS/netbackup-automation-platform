# $Copyright: Copyright (c) 2025 Cohesity, Inc. All rights reserved $

# NetBackup Server - Upgrade - Primary Server
- name: NETBACKUP -> PRIMARY SERVER UPGRADE
  gather_facts: true
  become: yes
  hosts: all
  environment:
    NB_TMPDIR: "/usr/openv/tmp"
    PAR_GLOBAL_TMPDIR: "/usr/openv/tmp"
  pre_tasks:
    - name: Retrieving host distribution
      setup:
        gather_subset:
          - "!all"
          - "!min"
          - "distribution"

    - name: "NBU-{{ nbu_role|upper }}-{{ nbu_playbook_type|upper }} Fail if nbu_primary_server_ans is defined"
      ansible.builtin.fail:
        msg: "The 'nbu_primary_server_ans' should not be defined for {{ nbu_role|lower }} {{ nbu_playbook_type|lower }} playbook."
      when: nbu_primary_server_ans is defined

    - name: "NBU-{{ nbu_role|upper }}-{{ nbu_playbook_type|upper }} -> Load configurable variables"
      ansible.builtin.include_vars: "vars/linux.yml"
      tags: ["always"]
      no_log: True

  roles:
   - role: 'netbackup'                                        # Load netbackup common defaults
   - role: 'netbackup/posix'                                   # Load netbackup default vars
   - role: 'generic/is_nbu_version_supported'
   - role: 'generic/os_compatibility'
   - role: 'helper/detect_partial_install'
   - role: 'generic/nbu_compatibility'
   - role: 'generic/nbu_verification'                           # Verifies certificate specific checks and report
   - { role: 'netbackup/common/rest-api-integration', action: "login" }
   - role: 'netbackup/common/rest-api-integration/catalog_images'
   - { role: 'netbackup/common/rest-api-integration', action: "logout" }
   - role: 'netbackup/posix/nbu-server-install/v2.0'
   - role: 'generic/nbu_verification'                           # Verifies certificate specific checks and report
   - role: 'netbackup/posix/nbu-install-eeb/v2.0'
  vars:
    # Role Control
    nbu_role: "primary"
    nbu_playbook_type: "upgrade"
    
# EOF
